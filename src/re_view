CREATE VIEW analysis.orders as 
with sub_status as(
SELECT ao.order_id, ao.status_id as status
FROM production.orderstatuslog ao
INNER join (select order_id, max(dttm) as dttm
FROM production.orderstatuslog
GROUP by order_id) as t
ON t.order_id=ao.order_id
AND t.dttm=ao.dttm)
select ao.order_id, ao.order_ts, ao.user_id, ao.bonus_payment, ao.payment, ao.cost, ao.bonus_grant, sub_status.status
from production.orders ao
left join sub_status
on sub_status.order_id=ao.order_id;
